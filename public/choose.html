<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <title>Balanced Leaky Queue demo : choose</title>
    <link href="https://getbootstrap.com/docs/4.1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="assets/styles.css" rel="stylesheet">
    <link href="assets/choose.css" rel="stylesheet">
</head>
<body>

<div class="container">
    <nav class="navbar navbar-expand-lg navbar-light bg-light rounded">
        <a class="navbar-brand" href="index.html">
            <img src="assets/logo.svg" alt="">
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#blqueue-navbar" aria-controls="blqueue-navbar" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="blqueue-navbar">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item">
                    <a class="nav-link" href="index.html">Reconnect <span class="sr-only">(current)</span></a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="choose.html">Index</a>
                </li>
            </ul>
        </div>
    </nav>
    <div id="container"></div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
<script>
    $(document).ready(function(){
        let apiUrl = localStorage.getItem('apiUrl');

        if (apiUrl == null || apiUrl.length === 0) {
            $('#container').html('<div class="alert alert-danger" role="alert">Demo app API url isn\'t set. Go <a href="index.html">back</a> and try to connect again.</div>');
        } else {
            $.get(apiUrl + 'list', function(response){
                if (response.status === 200) {
                    let list = JSON.parse(response.message);
                    let output = '';
                    for (let i in list) {
                        let item = list[i];
                        output += '<div class="media text-muted pt-3">\n' +
                            '  <div class="mr-2 status status-' + item.queue.status + '"></div>\n' +
                            '  <div class="media-body pb-3 mb-0 small lh-125 border-bottom border-gray">\n' +
                            '    <a href="#" class="d-block" onclick="localStorage.setItem(\'queueID\', \'' + item.key + '\');document.location=\'queue.html\'">@' + item.key + '</a>\n' +
                            '    <div class="d-flex justify-content-between align-items-center w-100">\n' +
                            '      <span class="text-gray-dark">Size: ' + item.queue.size + '; Fullness: ' + item.queue.fullness_rate*100 + '%; Workers: ' + item.queue.workers_active + '/' + item.queue.workers_max  + '; Producers: ' + item.producers_active + '/' + item.producers_max  + '</span>\n' +
                            '    </div>\n' +
                            '  </div>\n' +
                            '</div>';
                    }
                    if (output.length === 0) {
                        output += '<div class="media text-muted pt-3">\n' +
                            '  <div class="media-body pb-3 mb-0 small lh-125 border-bottom border-gray">\n' +
                            '    <div class="alert alert-warning" role="alert">No running queues found!</div>' +
                            '  </div>\n' +
                            '</div>';
                    }
                    $('#container').html('<div class="my-3 p-3 bg-white rounded box-shadow"><h6 class="border-bottom border-gray pb-2 mb-0">Running queues</h6>' + output + '<small class="d-block text-right mt-3"><a href="init.html">Add new</a></small></div>');
                }
            }).fail(function(){
                $('#container').html('<div class="alert alert-danger" role="alert">Couldn\'t retrieve list of running queues. Try again later.</div>');
            });
        }
    });
</script>
</body>
</html>
